<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Detailed Static/Dynamic Analysis For (CVE-2022-21661) ::
        Confidential Team — UnKn0wn
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Introduction: Most likely in such cases where we have a CVE ID number and we want to investigate more about it either to write a working POC or any other purposes one of our approaches is to start from the action that the vendor&amp;rsquo;s dev team has taken in order to patch the vulnerability.
For this case ( CVE-2022–21661 - SQL injection in the Core of Wordpress ) the Wordpress developers team action to patch this issue can be seen in the following commit:"
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/cve-202221661/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Detailed Static/Dynamic Analysis For (CVE-2022-21661)"/>
<meta name="twitter:description" content="Introduction: Most likely in such cases where we have a CVE ID number and we want to investigate more about it either to write a working POC or any other purposes one of our approaches is to start from the action that the vendor&rsquo;s dev team has taken in order to patch the vulnerability.
For this case ( CVE-2022–21661 - SQL injection in the Core of Wordpress ) the Wordpress developers team action to patch this issue can be seen in the following commit:"/>



<meta property="og:title" content="Detailed Static/Dynamic Analysis For (CVE-2022-21661)" />
<meta property="og:description" content="Introduction: Most likely in such cases where we have a CVE ID number and we want to investigate more about it either to write a working POC or any other purposes one of our approaches is to start from the action that the vendor&rsquo;s dev team has taken in order to patch the vulnerability.
For this case ( CVE-2022–21661 - SQL injection in the Core of Wordpress ) the Wordpress developers team action to patch this issue can be seen in the following commit:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/cve-202221661/" />
<meta property="article:published_time" content="2022-01-13T15:55:16-05:00" />
<meta property="article:modified_time" content="2022-01-13T15:55:16-05:00" /><meta property="og:site_name" content="Confidential Team" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Confidential Team</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Detailed Static/Dynamic Analysis For (CVE-2022-21661)</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-01-13
        </span>

        
          
        
      

      


      
        <span class="post-read-time"
          >— 4 min read</span
        >
      
    </div>

    

    

    <div class="post-content">
      
      <h2 id="introduction">Introduction:</h2>
<p>Most likely in such cases where we have a CVE ID number and we want to investigate more about it either to write a working POC or any other purposes one of our approaches is to start from the action that the vendor&rsquo;s dev team has taken in order to patch the vulnerability.</p>
<p>For this case ( CVE-2022–21661 - SQL injection in the Core of Wordpress ) the Wordpress developers team action to patch this issue can be seen in the following commit:</p>
<p><img src="../../img/CVE-2022%E2%80%9321661/1.png" alt=""></p>
<h2 id="investigation">Investigation:</h2>
<p>As we have seen above, it&rsquo;s clearly that the issue is about the <code>$query['terms']</code> in line <code>559</code> which&rsquo;s located in <code>wp-includes/class-wp-tax-query.php</code> so we installed Wordpress locally and fired-up the VS Code to start investigating more and figure out what&rsquo;s wrong with <code>$query['terms']</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/2.png" alt=""></p>
<p>The <code>array $query</code> is being passed as a parameter to the <code>function clean_query</code> which is to <code>Validates a single query</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/3.png" alt=""></p>
<p>Th function <code>clean_query()</code> has two conditions , so let&rsquo;s see how we can avoid changing the value of <code>$query['terms']</code>.</p>
<p>One thing could be done is  making the <code>$query['taxonomy']</code> empty and assigned <code>term_taxonomy_id</code> to <code>$query['field']</code> then we will hit the  <code>line 559 </code> without any changing of the <code>$query['terms']</code> value we will continue till the <code>line 579</code>
<code>$this-&gt;transform_query( $query, 'term_taxonomy_id' );</code></p>
<p>let&rsquo;s see what&rsquo;s that function transform_query() doing :</p>
<p><img src="../../img/CVE-2022%E2%80%9321661/4.png" alt=""></p>
<p>it firstly check if the <code>$query['terms']</code> is empty or not ( which&rsquo;s not empty in our case) then it will make sure that <code>$query['field'] == $resulting_field</code> at <code>line 601</code> which&rsquo;s already satisfied since it&rsquo;s passed  <code>'term_taxonomy_id'</code> as the second parameter in the previews step
<code>$this-&gt;transform_query( $query, 'term_taxonomy_id' );</code></p>
<p>Now since we Successfully reached to this point it means two things:</p>
<p>1-What ever we put in <code>$query['terms']</code> won&rsquo;t be changed ( we made sure of that in above steps)
2-We just need to find a way to make this useful for us.</p>
<h2 id="exploitation">Exploitation:</h2>
<p>Looking at the CVE-2022–21661 description in MITRE we can see that it can be reached from <code>WP_Query class</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/5.png" alt=""></p>
<p>By simple search we figured out that the WP_Query class is located at <code> wp-includes/class-wp-query.php</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/6.png" alt=""></p>
<p>So we start by reading the <code>public function __construct()</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/7.png" alt=""></p>
<p>From there we see that our query will be passed to <code>query()</code> which will <code> Sets up the WordPress query by parsing query string.</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/8.png" alt=""></p>
<p>Then it will return <code>return $this-&gt;get_posts();</code> so we jumped to the <code>get_posts()</code> which <code>Retrieves an array of posts based on query variables</code>
and at <code>line 2138</code> it will take us to <code>$clauses = $this-&gt;tax_query-&gt;get_sql( $wpdb-&gt;posts, 'ID' );</code></p>
<p>By doing so the path to trigger the Error-Based SQL injection was:
<code>__construct()&gt; query()&gt; get_posts()&gt; get_sql() at line 2138&gt; get_sql_clauses() at line 250&gt; get_sql_for_query() at line 247&gt; get_sql_for_clause() at line 324&gt; clean_query() at line 394 </code></p>
<p>Finally, after lots of breaking-points and tracking down the whole issue our team has  made this plugin that will firstly create an object from the <code>WP_Query class</code> then passing all the requirements we discussed above  and finally making a Non-authenticated Ajax actions for logged-out users.</p>
<p><img src="../../img/CVE-2022%E2%80%9321661/9.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">
<span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#75715e">/*
</span><span style="color:#75715e">Plugin Name: CVE-2022-21661 Plugin
</span><span style="color:#75715e">Description: This plugin was made in order to test ( CVE-2022-21661 )
</span><span style="color:#75715e">Version: 1337
</span><span style="color:#75715e">Author: Confidential Team
</span><span style="color:#75715e">Author&#39;s Twitter : @ConfidentialTM
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">testinSQLinjection</span>(){
    <span style="color:#75715e">//Args to be passed to the WP_Query class object
</span><span style="color:#75715e"></span>    $args <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(
        <span style="color:#e6db74">&#39;tax_query&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(
        <span style="color:#e6db74">&#39;Confidential&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(
        <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;term_taxonomy_id&#39;</span>,
        <span style="color:#e6db74">&#39;terms&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;&#39;&#34;</span>),
        )
    )
);
    <span style="color:#75715e">//WP_Query class object with specific args 2 trigger the SQLinjection
</span><span style="color:#75715e"></span>    $trigger <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WP_Query</span>($args);
    <span style="color:#66d9ef">return</span> $trigger;
}
    <span style="color:#75715e">// Non-authenticated Ajax actions for logged-out users
</span><span style="color:#75715e"></span><span style="color:#a6e22e">add_action</span>(<span style="color:#e6db74">&#39;wp_ajax_nopriv_Confidential&#39;</span>,<span style="color:#e6db74">&#39;testinSQLinjection&#39;</span>);
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Activating the plugin:</p>
<p><img src="../../img/CVE-2022%E2%80%9321661/10.png" alt=""></p>
<p>Then in order to track all the steps and making sure of everything we sat-up breaking points and send the request:</p>
<p><img src="../../img/CVE-2022%E2%80%9321661/11.png" alt="">
<img src="../../img/CVE-2022%E2%80%9321661/12.png" alt="">
<img src="../../img/CVE-2022%E2%80%9321661/13.png" alt="">
<img src="../../img/CVE-2022%E2%80%9321661/14.png" alt="">
<img src="../../img/CVE-2022%E2%80%9321661/15.png" alt="">
<img src="../../img/CVE-2022%E2%80%9321661/16.png" alt=""></p>
<p>Here we can noticed  from the Variables section at the top-left corner that the <code>$query['taxonomy']</code> is empty and  <code>$query['field'] = term_taxonomy_id</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/17.png" alt=""></p>
<p>Finally:</p>
<p><img src="../../img/CVE-2022%E2%80%9321661/18.png" alt=""></p>
<h2 id="conclusion">Conclusion:</h2>
<p>This vulnerability arises at the core of Wordpress yet it couln&rsquo;t be triggered without a plugin or theme that goes the whole way we discussed above.</p>
<h2 id="credit-">Credit :</h2>
<p>This issue was documented back 2019 by @Paul_Axe and at the end of 2021 year the GiaoHangTietKiem JSC team has reported it to the Wordpress team and got the CVE for it several days ago jan 6, 2022.</p>
<h2 id="references">References:</h2>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-21661">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-21661</a></li>
<li><a href="https://github.com/WordPress/WordPress/commit/271b1f60cd3e46548bd8aeb198eb8a923b9b3827?diff=split">https://github.com/WordPress/WordPress/commit/271b1f60cd3e46548bd8aeb198eb8a923b9b3827?diff=split</a></li>
<li><a href="https://2019.zeronights.ru/wp-content/themes/zeronights-2019/public/materials/7_PaulAxe_ZN_PWN_Challenge.pdf">https://2019.zeronights.ru/wp-content/themes/zeronights-2019/public/materials/7_PaulAxe_ZN_PWN_Challenge.pdf</a></li>
<li><a href="https://cognn-medium-com.translate.goog/sql-injection-in-wordpress-core-zdi-can-15541-a451c492897?source=social.tw&amp;_x_tr_sl=vi&amp;_x_tr_tl=en&amp;_x_tr_hl=ar">https://cognn-medium-com.translate.goog/sql-injection-in-wordpress-core-zdi-can-15541-a451c492897?source=social.tw&amp;_x_tr_sl=vi&amp;_x_tr_tl=en&amp;_x_tr_hl=ar</a></li>
<li><a href="https://wordpress-org.translate.goog/news/2022/01/wordpress-5-8-3-security-release/?_x_tr_sl=vi&amp;_x_tr_tl=en&amp;_x_tr_hl=ar">https://wordpress-org.translate.goog/news/2022/01/wordpress-5-8-3-security-release/?_x_tr_sl=vi&amp;_x_tr_tl=en&amp;_x_tr_hl=ar</a></li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/posts/cve-202221661ar/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Detailed Static/Dynamic Analysis For (CVE-2022-21661)</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/posts/infiltrationar/">
                  <span class="button__text">Infiltrating CS Beacon throughout different mediums</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Confidential Team</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2022 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
