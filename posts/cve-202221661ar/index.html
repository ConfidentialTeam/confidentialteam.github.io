<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Detailed Static/Dynamic Analysis For (CVE-2022-21661) ::
        Confidential Team — UnKn0wn
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Introduction: السلام عليكم ورحمة الله وبركاته  في أغلب الأوقات إذا كان فيه CVE ID number وكان الهدف الوصول إلى كتابة إستغلال هناك طرق وأساليب مختلفة أحدها هو الطريقة المستخدمة اليوم والفكرة هنا نبدأ من حيث إنتهى فريق المطورين الخاص بالمنتج المصاب. بما معناه نشوف وش كانت طريقة الفريق في عمل patching للثغرة ونبدأ من هناك  في حالتنا اليوم ( CVE-2022–21661 - SQL injection in the Core of Wordpress ) قام فريق المطورين بـ Worddpress بعمل الحل التالي  Investigation: مثل ماشفنا بالصورة فوق."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/cve-202221661ar/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Detailed Static/Dynamic Analysis For (CVE-2022-21661)"/>
<meta name="twitter:description" content="Introduction: السلام عليكم ورحمة الله وبركاته  في أغلب الأوقات إذا كان فيه CVE ID number وكان الهدف الوصول إلى كتابة إستغلال هناك طرق وأساليب مختلفة أحدها هو الطريقة المستخدمة اليوم والفكرة هنا نبدأ من حيث إنتهى فريق المطورين الخاص بالمنتج المصاب. بما معناه نشوف وش كانت طريقة الفريق في عمل patching للثغرة ونبدأ من هناك  في حالتنا اليوم ( CVE-2022–21661 - SQL injection in the Core of Wordpress ) قام فريق المطورين بـ Worddpress بعمل الحل التالي  Investigation: مثل ماشفنا بالصورة فوق."/>



<meta property="og:title" content="Detailed Static/Dynamic Analysis For (CVE-2022-21661)" />
<meta property="og:description" content="Introduction: السلام عليكم ورحمة الله وبركاته  في أغلب الأوقات إذا كان فيه CVE ID number وكان الهدف الوصول إلى كتابة إستغلال هناك طرق وأساليب مختلفة أحدها هو الطريقة المستخدمة اليوم والفكرة هنا نبدأ من حيث إنتهى فريق المطورين الخاص بالمنتج المصاب. بما معناه نشوف وش كانت طريقة الفريق في عمل patching للثغرة ونبدأ من هناك  في حالتنا اليوم ( CVE-2022–21661 - SQL injection in the Core of Wordpress ) قام فريق المطورين بـ Worddpress بعمل الحل التالي  Investigation: مثل ماشفنا بالصورة فوق." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/cve-202221661ar/" />
<meta property="article:published_time" content="2022-01-13T16:34:51-05:00" />
<meta property="article:modified_time" content="2022-01-13T16:34:51-05:00" /><meta property="og:site_name" content="Confidential Team" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Confidential Team</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Detailed Static/Dynamic Analysis For (CVE-2022-21661)</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-01-13
        </span>

        
          
        
      

      


      
        <span class="post-read-time"
          >— 3 min read</span
        >
      
    </div>

    

    

    <div class="post-content">
      
      <h2 id="introduction">Introduction:</h2>
<DIV dir="rtl" align="right">
السلام عليكم ورحمة الله وبركاته
</DIV>
<DIV dir="rtl" align="right">
  في أغلب الأوقات إذا كان فيه
CVE ID number
 وكان الهدف الوصول إلى كتابة إستغلال
هناك طرق وأساليب مختلفة أحدها هو الطريقة المستخدمة اليوم والفكرة هنا نبدأ من حيث إنتهى فريق المطورين الخاص بالمنتج المصاب.
   بما معناه نشوف وش كانت طريقة الفريق في عمل
	patching
للثغرة ونبدأ من هناك
</DIV>
<DIV dir="rtl" align="right">
في حالتنا اليوم
( CVE-2022–21661 - SQL injection in the Core of Wordpress )
قام فريق المطورين بـ
Worddpress
 بعمل الحل التالي
</DIV>
<p><img src="../../img/CVE-2022%E2%80%9321661/1.png" alt=""></p>
<h2 id="investigation">Investigation:</h2>
<DIV dir="rtl" align="right">
مثل ماشفنا بالصورة فوق. واضح جدا المشكلة تتعلق بـ
</DIV>
<p><code> $query['terms'] at line 559</code></p>
<DIV dir="rtl" align="right">
اللي هو موجود في ملف
</DIV>
<p><code>wp-includes/class-wp-tax-query.php</code></p>
<DIV dir="rtl" align="right">
 بعد ماعرفنا المعلومتين هذي قمنا بتنصيب الـ 
Wordpress locally
</DIV>
<DIV dir="rtl" align="right">
  وبعدها فتحنا برنامج الـ 
VS Code
بهدف البدء في التحليل ونشوف وش المشكلة المتعلقة بـ 
</DIV>
<p><code> $query['terms'] at line 559</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/2.png" alt=""></p>
  <DIV dir="rtl" align="right">
الـ
</DIV>
<p><code>array $query</code></p>
<DIV dir="rtl" align="right">
تعتبر كمتغير للدالة
</DIV>
<p><code>function clean_query</code></p>
<DIV dir="rtl" align="right">
اللي بالأساس وظيفتها
</DIV>
<p><code>Validates a single query</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/3.png" alt=""></p>
<DIV dir="rtl" align="right">
الدالة
</DIV>
<p><code>clean_query()</code></p>
 <DIV dir="rtl" align="right">
فيها شرطين والهدف هنا هو المحافظة على قيمة
</DIV>
<p><code>$query['terms']</code></p>
<DIV dir="rtl" align="right">
بحيث أن قيمتها تبقى ثابتة وماتتغير 
</DIV>
<DIV dir="rtl" align="right">
يمكننا بكل بساطة جعل قيمة
</DIV>
<p><code>$query['taxonomy']</code></p>
<DIV dir="rtl" align="right">
فارغة و
</DIV>
<p><code>$query['field'] === term_taxonomy_id</code></p>
<DIV dir="rtl" align="right">
وبكذا راح نوصل للسطر رقم
</DIV>
<p><code>559 </code></p>
<DIV dir="rtl" align="right">
ونستمر لحد مانوصل للسطر رقم
</DIV>
<p><code>579</code></p>
<DIV dir="rtl" align="right">
هذا
</DIV>
<p><code>$this-&gt;transform_query( $query, 'term_taxonomy_id' );</code></p>
  <DIV dir="rtl" align="right">
خلونا نشوف إيش وظيفة الدالة 
 </DIV>
<p><code>transform_query()</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/4.png" alt=""></p>
  <DIV dir="rtl" align="right">
فالبداية راح تتأكد من أن قيمة
 </DIV>
<p><code>$query['terms']</code></p>
<DIV dir="rtl" align="right">
فارغة أم لا ؟
اللي هي بحالتنا راح يكون فيها قيمة. بعد ذلك راح تتأكد من أن قيمة
</DIV>
<p><code>$query['field'] === $resulting_field</code> at <code>line 601</code></p>
 <DIV dir="rtl" align="right">
 وهذا الشي موجود مسبقا في الخطوة السابقة بتمرير القيمة 
</DIV>
<p><code>'term_taxonomy_id'</code></p>
<DIV dir="rtl" align="right">
	للدالة
</DIV>
<p><code>transform_query()</code></p>
  <DIV dir="rtl" align="right">
الآن بما أننا وصلنا لهذي المرحلة وقدرنا نحافظ على قيمة 
</DIV>
<p><code>$query['terms']</code></p>
 <DIV dir="rtl" align="right">
	الهدف صار , كيف نوصل لإستغلال لهالشي ؟ 
 </DIV>
<h2 id="exploitation">Exploitation:</h2>
  <DIV dir="rtl" align="right">
بالرجوع إلى وصف الثغرة في موقع 
MITRE
 </DIV>
  <DIV dir="rtl" align="right">
راح نشوف أن هذي الثغرة تبدأ من 
 </DIV>
<p><code>WP_Query class</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/5.png" alt=""></p>
  <DIV dir="rtl" align="right">
وببحث بسيط نشوف أن هذا الكلاس يتواجد بملف 
  </DIV>
<p><code> wp-includes/class-wp-query.php</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/6.png" alt=""></p>
  <DIV dir="rtl" align="right">
وبكذا بدأنا بقراءة الـ
 </DIV>
<p><code>public function __construct()</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/7.png" alt=""></p>
<DIV dir="rtl" align="right">
ومن هناك نشوف أنه يتم تمرير القيمة إلى دالة
</DIV>
<p><code>query()</code></p>
  <DIV dir="rtl" align="right">
واللي بكل بساطة تسوي
</DIV>
<p><code> Sets up the WordPress query by parsing query string.</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/8.png" alt=""></p>
<DIV dir="rtl" align="right">
وفالنهاية راح تسوي
</DIV>
<p><code>return $this-&gt;get_posts();</code></p>
<DIV dir="rtl" align="right">
وبكذا لازم نشوف دالة
</DIV>
<p><code>get_posts()</code></p>
<DIV dir="rtl" align="right">
وش تسوي وإيش فيها بالضبط ؟
</DIV>
<DIV dir="rtl" align="right">
بإختصار فالسطر رقم 2138 من الدالة نشوف إننا راح نمرر القيم لدالة 
get_sql
</DIV>
<p><code>$clauses = $this-&gt;tax_query-&gt;get_sql( $wpdb-&gt;posts, 'ID' );</code></p>
  <DIV dir="rtl" align="right">
وبالإستكمال على هذي الطريقة راح نتوصل للطريق الكامل للوصول للمبتغى عن طريق 
 </DIV>
<p><code>__construct()&gt; query()&gt; get_posts()&gt; get_sql() at line 2138&gt; get_sql_clauses() at line 250&gt; get_sql_for_query() at line 247&gt; get_sql_for_clause() at line 324&gt; clean_query() at line 394 </code></p>
  <DIV dir="rtl" align="right">
	أخيرا, بعد وضع الكثير من الـ 
break-points 
	وتتبع كل دالة قام فريقنا بعمل
	 </DIV>
<p><code>Wordpress Plugin</code></p>
  <DIV dir="rtl" align="right">
فالبداية راح يتم عمل اوبجكت من الكلاس 
	 </DIV>
<p><code>WP_Query class</code></p>
  <DIV dir="rtl" align="right">
وبعدها تمرير كل المتطلبات اللي ناقشناها سابقا. وأخيرا عمل 
Non-authenticated Ajax actions for logged-out users
 </DIV>
<p><img src="../../img/CVE-2022%E2%80%9321661/9.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#75715e">/*
</span><span style="color:#75715e">Plugin Name: CVE-2022-21661 Plugin
</span><span style="color:#75715e">Description: This plugin was made in order to test ( CVE-2022-21661 )
</span><span style="color:#75715e">Version: 1337
</span><span style="color:#75715e">Author: Confidential Team
</span><span style="color:#75715e">Author&#39;s Twitter : @ConfidentialTm
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">testinSQLinjection</span>(){
    <span style="color:#75715e">//Args to be passed to the WP_Query class object
</span><span style="color:#75715e"></span>    $args <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(
        <span style="color:#e6db74">&#39;tax_query&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(
        <span style="color:#e6db74">&#39;Confidential&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(
        <span style="color:#e6db74">&#39;field&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;term_taxonomy_id&#39;</span>,
        <span style="color:#e6db74">&#39;terms&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;&#39;&#34;</span>),
        )
    )
);
    <span style="color:#75715e">//WP_Query class object with specific args 2 trigger the SQLinjection
</span><span style="color:#75715e"></span>    $trigger <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WP_Query</span>($args);
    <span style="color:#66d9ef">return</span> $trigger;
}
    <span style="color:#75715e">//Non-authenticated Ajax actions for logged-out users
</span><span style="color:#75715e"></span><span style="color:#a6e22e">add_action</span>(<span style="color:#e6db74">&#39;wp_ajax_nopriv_Confidential&#39;</span>,<span style="color:#e6db74">&#39;testinSQLinjection&#39;</span>);
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><DIV dir="rtl" align="right">
 تفعيل الـ
 :Plugin
</DIV>
<p><img src="../../img/CVE-2022%E2%80%9321661/10.png" alt=""></p>
  <DIV dir="rtl" align="right">
 ولمراقبة كل الخطوات السابقة والتأكد من الوصول للهدف قمنا بعمل 
Break-Points
وبعدها قمنا بإرسال الريكويست النهائي
 </DIV>
<p><img src="../../img/CVE-2022%E2%80%9321661/11.png" alt="">
<img src="../../img/CVE-2022%E2%80%9321661/12.png" alt="">
<img src="../../img/CVE-2022%E2%80%9321661/13.png" alt="">
<img src="../../img/CVE-2022%E2%80%9321661/14.png" alt="">
<img src="../../img/CVE-2022%E2%80%9321661/15.png" alt="">
<img src="../../img/CVE-2022%E2%80%9321661/16.png" alt=""></p>
  <DIV dir="rtl" align="right">
هنا بالنظر للزاوية اليسار بالأعلى نلاحظ أن القيم كانت بالشكل المطلوب تماما 
 </DIV>
<p><code>$query['taxonomy']</code> is empty and  <code>$query['field'] = term_taxonomy_id</code></p>
<p><img src="../../img/CVE-2022%E2%80%9321661/17.png" alt=""></p>
   <DIV dir="rtl" align="right">
 أخيرا :
  </DIV>
<p><img src="../../img/CVE-2022%E2%80%9321661/18.png" alt=""></p>
<h2 id="conclusion">Conclusion:</h2>
   <DIV dir="rtl" align="right">
 فالنهاية, هذه الثغرة تعتبر بالكود البرمجي الأساسي لوورد بريس 
ومع ذلك لايمكن إستغلالها مباشرة. إلا بوجود 
Plugin or Theme
يكون فيها كل البروسيس المذكور سابقا.
  </DIV>
<h2 id="credit-">Credit :</h2>
<p>This issue was documented back 2019 by @Paul_Axe and at the end of 2021 year the GiaoHangTietKiem JSC team has reported it to the Wordpress team and got the CVE for it several days ago jan 6, 2022.</p>
<h2 id="references">References:</h2>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-21661">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-21661</a></li>
<li><a href="https://github.com/WordPress/WordPress/commit/271b1f60cd3e46548bd8aeb198eb8a923b9b3827?diff=split">https://github.com/WordPress/WordPress/commit/271b1f60cd3e46548bd8aeb198eb8a923b9b3827?diff=split</a></li>
<li><a href="https://2019.zeronights.ru/wp-content/themes/zeronights-2019/public/materials/7_PaulAxe_ZN_PWN_Challenge.pdf">https://2019.zeronights.ru/wp-content/themes/zeronights-2019/public/materials/7_PaulAxe_ZN_PWN_Challenge.pdf</a></li>
<li><a href="https://cognn-medium-com.translate.goog/sql-injection-in-wordpress-core-zdi-can-15541-a451c492897?source=social.tw&amp;_x_tr_sl=vi&amp;_x_tr_tl=en&amp;_x_tr_hl=ar">https://cognn-medium-com.translate.goog/sql-injection-in-wordpress-core-zdi-can-15541-a451c492897?source=social.tw&amp;_x_tr_sl=vi&amp;_x_tr_tl=en&amp;_x_tr_hl=ar</a></li>
<li><a href="https://wordpress-org.translate.goog/news/2022/01/wordpress-5-8-3-security-release/?_x_tr_sl=vi&amp;_x_tr_tl=en&amp;_x_tr_hl=ar">https://wordpress-org.translate.goog/news/2022/01/wordpress-5-8-3-security-release/?_x_tr_sl=vi&amp;_x_tr_tl=en&amp;_x_tr_hl=ar</a></li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="/posts/infiltrationar/">
                  <span class="button__text">Infiltrating CS Beacon throughout different mediums</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Confidential Team</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2022 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
