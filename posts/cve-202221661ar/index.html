<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Detailed Static/Dynamic Analysis For (CVE-2022-21661) ::
        Confidential Team — UnKn0wn
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="مقدمة السلام عليكم ورحمة الله وبركاته.
وكان الهدف الوصول إلى كتابة إستغلال CVE ID numberفي أغلب الأوقات إذا كان فيه
هناك طرق وأساليب مختلفة أحدها هو الطريقة المستخدمة اليوم والفكرة هنا نبدأ من حيث إنتهى فريق المطورين الخاص بالمنتج المصاب. للثغرة ونبدأ من هناك patching بما معناه نشوف وش كانت طريقة الفريق في عمل
في حالتنا اليوم ( CVE-2022–21661 - SQL injection in the Core of Wordpress ) :قام بعمل الحل التالي Worddpressفريق المطورين بـ (pic 1)"
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/cve-202221661ar/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Detailed Static/Dynamic Analysis For (CVE-2022-21661)"/>
<meta name="twitter:description" content="مقدمة السلام عليكم ورحمة الله وبركاته.
وكان الهدف الوصول إلى كتابة إستغلال CVE ID numberفي أغلب الأوقات إذا كان فيه
هناك طرق وأساليب مختلفة أحدها هو الطريقة المستخدمة اليوم والفكرة هنا نبدأ من حيث إنتهى فريق المطورين الخاص بالمنتج المصاب. للثغرة ونبدأ من هناك patching بما معناه نشوف وش كانت طريقة الفريق في عمل
في حالتنا اليوم ( CVE-2022–21661 - SQL injection in the Core of Wordpress ) :قام بعمل الحل التالي Worddpressفريق المطورين بـ (pic 1)"/>



<meta property="og:title" content="Detailed Static/Dynamic Analysis For (CVE-2022-21661)" />
<meta property="og:description" content="مقدمة السلام عليكم ورحمة الله وبركاته.
وكان الهدف الوصول إلى كتابة إستغلال CVE ID numberفي أغلب الأوقات إذا كان فيه
هناك طرق وأساليب مختلفة أحدها هو الطريقة المستخدمة اليوم والفكرة هنا نبدأ من حيث إنتهى فريق المطورين الخاص بالمنتج المصاب. للثغرة ونبدأ من هناك patching بما معناه نشوف وش كانت طريقة الفريق في عمل
في حالتنا اليوم ( CVE-2022–21661 - SQL injection in the Core of Wordpress ) :قام بعمل الحل التالي Worddpressفريق المطورين بـ (pic 1)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/cve-202221661ar/" />
<meta property="article:published_time" content="2022-01-13T16:34:51-05:00" />
<meta property="article:modified_time" content="2022-01-13T16:34:51-05:00" /><meta property="og:site_name" content="Confidential Team" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Confidential Team</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Detailed Static/Dynamic Analysis For (CVE-2022-21661)</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-01-13
        </span>

        
          
        
      

      


      
        <span class="post-read-time"
          >— 3 min read</span
        >
      
    </div>

    

    

    <div class="post-content">
      
      <h1 id="مقدمة">مقدمة</h1>
<p>السلام عليكم ورحمة الله وبركاته.</p>
<p>وكان الهدف الوصول إلى كتابة إستغلال CVE ID numberفي أغلب الأوقات إذا كان فيه<br>
هناك طرق وأساليب مختلفة أحدها هو الطريقة المستخدمة اليوم والفكرة هنا نبدأ من حيث إنتهى فريق المطورين الخاص بالمنتج المصاب.
للثغرة ونبدأ من هناك patching بما معناه نشوف وش كانت طريقة الفريق في عمل</p>
<p>في حالتنا اليوم
( CVE-2022–21661 - SQL injection in the Core of Wordpress )
:قام بعمل الحل التالي Worddpressفريق المطورين بـ
<code>(pic 1)</code></p>
<h1 id="تحليل">تحليل</h1>
<p>مثل ماشفنا بالصورة فوق. واضح جدا المشكلة تتعلق بـ
<code> $query['terms'] at line 559</code>
اللي هو موجود في ملف
<code>wp-includes/class-wp-tax-query.php</code></p>
<p>Wordpress locally بعد ماعرفنا المعلومتين هذي قمنا بتنصيب الـ
VS Code وبعدها فتحنا برنامج الـ
بهدف البدء في التحليل ونشوف وش المشكلة المتعلقة بـ
<code> $query['terms'] at line 559</code></p>
<p><code>(pic 2)</code></p>
<p><code>function clean_query</code> تعتبر كمتغير للدالة <code>array $query</code> الـ
اللي بالأساس وظيفتها
<code>Validates a single query</code>
<code>(pic 3)</code></p>
<p>فيها شرطين والهدف هنا هو المحافظة على قيمة <code>clean_query()</code> الدالة
<code>$query['terms']</code>
بحيث أن قيمتها تبقى ثابتة وماتتغير</p>
<p>فارغة و<code>$query['taxonomy']</code> يمكننا بكل بساطة جعل قيمة
<code>$query['field'] === term_taxonomy_id</code>
وبكذا راح نوصل للسطر رقم <code>559 </code> ونستمر لحد مانوصل للسطر رقم <code>579</code> هذا
<code>$this-&gt;transform_query( $query, 'term_taxonomy_id' );</code></p>
<p>خلونا نشوف إيش وظيفة الدالة
<code>transform_query()</code>
<code>( pic 4 )</code></p>
<p>فارغة أم لا ؟<code>$query['terms']</code> فالبداية راح تتأكد من أن قيمة
اللي هي بحالتنا راح يكون فيها قيمة. بعد ذلك راح تتأكد من أن قيمة
<code>$query['field'] === $resulting_field</code> at <code>line 601</code>
وهذا الشي موجود مسبقا في الخطوة السابقة بتمرير القيمة
<code>'term_taxonomy_id'</code>
للدالة
<code>transform_query()</code></p>
<p><code>$query['terms']</code>  الآن بما أننا وصلنا لهذي المرحلة وقدرنا نحافظ على قيمة
الهدف صار , كيف نوصل لإستغلال لهالشي ؟</p>
<h2 id="الإستغلال">الإستغلال</h2>
<p>راح نشوف أن هذي الثغرة تبدأ من MITRE بالرجوع إلى وصف الثغرة في موقع
<code>WP_Query class</code>
<code>(pic 5)</code></p>
<p>وببحث بسيط نشوف أن هذا الكلاس يتواجد بملف
<code> wp-includes/class-wp-query.php</code>
<code>(pic 6)</code></p>
<p>وبكذا بدأنا بقراءة الـ
<code>public function __construct()</code>
<code>(pic 7 )</code></p>
<p>ومن هناك نشوف أنه يتم تمرير القيمة إلى دالة
<code>query()</code>
واللي بكل بساطة تسوي
<code> Sets up the WordPress query by parsing query string.</code>
<code>(pic 8)</code></p>
<p>وفالنهاية راح تسوي
<code>return $this-&gt;get_posts();</code>
وبكذا لازم نشوف دالة
<code>get_posts()</code>
وش تسوي وإيش فيها بالضبط ؟
get_sql بإختصار فالسطر رقم 2138 من الدالة نشوف إننا راح نمرر القيم لدالة
<code>$clauses = $this-&gt;tax_query-&gt;get_sql( $wpdb-&gt;posts, 'ID' );</code></p>
<p>وبالإستكمال على هذي الطريقة راح نتوصل للطريق الكامل للوصول للمبتغى عن طريق
<code>__construct()&gt; query()&gt; get_posts()&gt; get_sql() at line 2138&gt; get_sql_clauses() at line 250&gt; get_sql_for_query() at line 247&gt; get_sql_for_clause() at line 324&gt; clean_query() at line 394 </code></p>
<p>وتتبع كل دالة قام فريقنا بعمل break-points أخيرا, بعد وضع الكثير من الـ
<code>Wordpress Plugin</code>
فالبداية راح يتم عمل اوبجكت من الكلاس
<code>WP_Query class</code>
وبعدها تمرير كل المتطلبات اللي ناقشناها سابقا. وأخيرا عمل
Non-authenticated Ajax actions for logged-out users</p>
<p><code>( pic 9 )</code></p>
<p><code>CODE OF plugin.php </code></p>
<p>:Plugin تفعيل الـ
<code>( pic 10 )</code></p>
<p>Break-Points ولمراقبة كل الخطوات السابقة والتأكد من الوصول للهدف قمنا بعمل
وبعدها قمنا بإرسال الريكويست النهائي:</p>
<p><code>( pic 11 )</code>
<code>( pic 12 )</code>
<code>( pic 13 )</code>
<code>( pic 14 )</code>
<code>( pic 15 )</code>
<code>( pic 16 )</code></p>
<p>هنا بالنظر للزاوية اليسار بالأعلى نلاحظ أن القيم كانت بالشكل المطلوب تماما
<code>$query['taxonomy']</code> is empty and  <code>$query['field'] = term_taxonomy_id</code></p>
<p><code>( pic 17 )</code></p>
<p>أخيرا :
<code>( pic 18 )</code></p>
<h2 id="conclusion">Conclusion:</h2>
<p>Wordpress فالنهاية, هذه الثغرة تعتبر بالكود البرمجي الأساسي لـ
ومع ذلك لايمكن إستغلالها مباشرة. إلا بوجود
Plugin or Theme
يكون فيها كل البروسيس المذكور سابقا.</p>
<h2 id="credit-">Credit :</h2>
<p>This issue was documented back 2019 by @Paul_Axe and at the end of 2021 year the GiaoHangTietKiem JSC team has reported it to the Wordpress team and got the CVE for it several days ago jan 6, 2022.</p>
<h2 id="references">References:</h2>
<ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-21661">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-21661</a></li>
<li><a href="https://github.com/WordPress/WordPress/commit/271b1f60cd3e46548bd8aeb198eb8a923b9b3827?diff=split">https://github.com/WordPress/WordPress/commit/271b1f60cd3e46548bd8aeb198eb8a923b9b3827?diff=split</a></li>
<li><a href="https://2019.zeronights.ru/wp-content/themes/zeronights-2019/public/materials/7_PaulAxe_ZN_PWN_Challenge.pdf">https://2019.zeronights.ru/wp-content/themes/zeronights-2019/public/materials/7_PaulAxe_ZN_PWN_Challenge.pdf</a></li>
<li><a href="https://cognn-medium-com.translate.goog/sql-injection-in-wordpress-core-zdi-can-15541-a451c492897?source=social.tw&amp;_x_tr_sl=vi&amp;_x_tr_tl=en&amp;_x_tr_hl=ar">https://cognn-medium-com.translate.goog/sql-injection-in-wordpress-core-zdi-can-15541-a451c492897?source=social.tw&amp;_x_tr_sl=vi&amp;_x_tr_tl=en&amp;_x_tr_hl=ar</a></li>
<li><a href="https://wordpress-org.translate.goog/news/2022/01/wordpress-5-8-3-security-release/?_x_tr_sl=vi&amp;_x_tr_tl=en&amp;_x_tr_hl=ar">https://wordpress-org.translate.goog/news/2022/01/wordpress-5-8-3-security-release/?_x_tr_sl=vi&amp;_x_tr_tl=en&amp;_x_tr_hl=ar</a></li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="/posts/cve-202221661/">
                  <span class="button__text">Detailed Static/Dynamic Analysis For (CVE-2022-21661)</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Confidential Team</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2022 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
